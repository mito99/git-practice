# DB Migration Tool

このディレクトリは、データベースのスキーマ変更（マイグレーション）を管理するためのプロジェクトです。
ツールとして **[golang-migrate](https://github.com/golang-migrate/migrate)** を使用していますが、フォルダ構成の整理と実行の簡略化のために `migrate.sh` ラッパースクリプト経由で操作します。

## 📂 ディレクトリ構成

```text
db-migration/
├── migrations/             # 開発者がSQLファイルを置く場所
│   ├── 2025_1Q/            # リリース時期やマイルストーンごとのサブフォルダ
│   │   ├── 202510001_init.up.sql
│   │   └── 202510001_init.down.sql
│   └── ...
├── .bin/                   # golang-migrate のバイナリ (隠しフォルダ)
├── .run_migrations/        # 実行時に生成される一時フォルダ (Git管理外)
├── migrate.sh              # ★実行用スクリプト (操作は全てこれ経由で行う)
└── README.md

```

### 環境変数の設定

実行には以下の環境変数が必要です。`.env` ファイルや export コマンドで設定してください。

| 変数名 | デフォルト値 | 説明 |
| --- | --- | --- |
| `DB_HOST` | `localhost` | DBサーバーのホスト名 |
| `DB_PORT` | `5432` | ポート番号 |
| `DB_NAME` | `mydb` | データベース名 |
| `DB_USER` | `user` | ユーザー名 |
| `DB_PASS` | `pass` | パスワード |

---

## 🛠 使い方 (コマンド)

基本的には `./migrate.sh` を使用します。

### 1. マイグレーションの実行 (Up)

未適用の変更をすべて適用します。

```bash
./migrate.sh up

```

### 2. ロールバック (Down)

**直近の1バージョン分だけ** 元に戻します。

```bash
./migrate.sh down

```

### 3. 現在の状態確認 (Version)

現在適用されている最新のバージョン番号を表示します。

```bash
./migrate.sh version

```

### 4. 指定バージョンへの移動 (Goto)

特定のバージョン番号の状態まで、自動的に Up または Down します。

```bash
./migrate.sh goto 202510001

```

### 5. 全データ削除 (Drop)

**【注意】** 全てのテーブルを削除し、真っ白な状態に戻します（開発環境のリセット用）。
実行時に確認プロンプトが表示されます。

```bash
./migrate.sh drop

```

---

## 📝 開発フロー

### 1. 新しいマイグレーションファイルの作成

`migrations/` 配下の適切なフォルダ（例: `2025_1Q/`）に、`.up.sql` と `.down.sql` のペアを作成します。

**命名規則:** `YYYYQ####_description.{up|down}.sql`

* 例: `202510001_create_users.up.sql`
* 例: `202510001_create_users.down.sql`

> **注意:** バージョン番号（`202510001`部分）はプロジェクト全体で重複しないように管理してください。

### 2. SQLの記述

* **Up:** テーブル作成、カラム追加、データパッチなど。
* **Down:** Upの操作を取り消す処理（DROP TABLEなど）。

### 3. 実行確認

ローカル環境で `up` と `down` が正常に動作することを確認してください。

---

## 🚑 トラブルシューティング

### "Dirty" 状態になった場合

マイグレーション実行中にSQLエラーが発生すると、DBが **Dirty状態**（不整合な状態）としてロックされ、以降のコマンドが失敗します。

**エラー例:**

```text
Dirty database version 202510001. Fix and force version.

```

**解消手順:**

1. エラーの原因となったSQLファイルを修正する。
2. DBの状態を手動で修正する（中途半端に作られたテーブルを削除するなど）。
3. 以下のコマンドで、強制的にバージョン情報を上書きしてロックを解除する。
```bash
# 例: 202510001 で失敗していた場合
./migrate.sh force 202510001

```

---
## ⚠️ 注意事項

* **ファイルの移動:** `migrations/` 以下のフォルダ構成は自由に変更できますが、**ファイル名のバージョン番号**だけは変更しないでください（実行順序が変わってしまいます）。
* **破壊的変更:** `down.sql` でデータを復元できない操作（カラム削除など）を行う場合は、事前にバックアップ等の運用手順を確認してください。