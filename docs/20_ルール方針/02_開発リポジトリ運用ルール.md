# 開発リポジトリ運用ガイド

本プロジェクトでは、GitFlowをベースに、**Issue起点（Issue-driven）** の開発フローを採用します。
すべての変更は追跡可能性（Traceability）を確保するため、Issue番号と紐づけて管理されます。

## 0. 役割定義 (Roles)

本ガイドでは、以下の役割に基づいて手順を記述します。

| 役割 | アイコン表記 | 定義と責任範囲 |
| :--- | :--- | :--- |
| **レビューイ** | `[レビューイ]` | **開発・設計の実務担当者**。<br>Issue消化、コーディング、単体テスト、PR作成、自身の担当ブランチの管理を行う。 |
| **レビュワー** | `[レビュワー]` | **品質ゲートキーパー**。<br>PRの内容確認、設計・コードレビュー、マージの承認（Approve）を行う。 |
| **リリース担当者** | `[リリース担当]` | **プロジェクトのリポジトリ管理者**。<br>リリースブランチの作成、商用(`main`)への反映、タグ付け、全体の整合性管理を行う。 |
| **AI (Copilot)** | `[AI]` | **開発アシスタント**。<br>本ガイドのルールに基づき、命名やコメントのドラフト作成を支援する。 |

---

## 1. ブランチ構成とマージ戦略

`main` および `release` への操作は、原則として **`[リリース担当]`** が管轄します。

| ブランチ名 | 管理責任者 | マージ戦略 (重要) | 理由 |
| :--- | :--- | :--- | :--- |
| **`main`** | **リリース担当** | **Merge Commit** | リリースの歴史を保持するため。 |
| **`develop`** | **リリース担当** | **Squash Merge** (from feature)<br>**Merge Commit** (from release) | 機能単位で履歴を綺麗にするため(Squash)。<br>リリース作業の統合記録を残すため(Merge)。 |
| **`release/vX.Y`** | **リリース担当** | **Merge Commit** | 検証中の修正履歴を正確に追うため。 |
| `feature/xxx` | レビューイ | - | `develop` へ Squash Merge される。 |
| `bugfix/xxx` | レビューイ | - | マージ先に応じて戦略が変わる。 |

---

## 2. 命名規則とAI指示 (Rules for Humans & AI)

`[レビューイ]` および `[AI]` は、以下のルールに従ってブランチ名、コミットメッセージ、PR記述を作成してください。

### ① ブランチ命名規則
* **フォーマット:** `{Prefix}/{Issue番号}-{簡易説明}`
* **Prefix:**
  * `feature/` : 新機能 (例: `feature/101-login-screen`)
  * `bugfix/` : バグ修正 (例: `bugfix/105-header-layout`)
  * `hotfix/` : 緊急対応 (例: `hotfix/108-critical-auth-error`)

### ② コミットのルール (粒度とメッセージ)
* **コミットの粒度 (Atomic Commits):**
  * `[レビューイ]` レビュー時に修正内容が理解できる単位でコミットしてください。「一つのコミットには一つの論理的な変更のみ」を含めるよう心がけます。
* **メッセージフォーマット:** `{変更内容の要約}`
  * **Note:** 作業中の各コミットメッセージにIssue番号は必須ではありません（最終的にSquashされるため）。
* **AIへの指示:**
  * 「修正」「更新」といった曖昧な言葉を使わず、**「なぜ、何を変更したか」** が伝わる具体的な日本語で記述すること。
  * **良い例:** `誤タップ防止のためログインボタンのパディングを拡大`

### ③ Pull Request (PR) のルール
PRタイトルは、Squash Merge された際にそのままコミットログとして残ります。

* **タイトル:** `[#{Issue番号}] {変更の概要}`
* **本文 (Body):**
  * `Closes #{Issue番号}` または `Fixes #{Issue番号}` を記述し、Issueを自動Closeさせる。
  * **What (何をしたか):** 変更箇所の具体的な説明。
  * **Why (なぜしたか):** その変更が必要だった背景、技術的な選定理由。

---

## 3. 通常開発フロー (Feature Flow)

### Step 1: Issue着手・実装
* `[レビューイ]` Issue番号（例: #101）が発番されたら作業を開始します。
* `[レビューイ]` `develop` から作業用ブランチを作成します。
  ```bash
  git checkout develop
  git checkout -b feature/101-add-login
  ```

### Step 2: プルリクエスト (PR) とレビュー
* `[レビューイ]` PRを作成し、適切な `[レビュワー]` をアサインします。
* `[レビュワー]` コードを確認し、問題なければ `Approve` します。
   * ※コミットが雑多で理解しづらい場合、レビュワーは整理（rebase/squash）を要求することができます。

### Step 3: マージ実行
* `[レビューイ]` (または `[レビュワー]`) Approveされた状態でマージを実行します。
* **マージの種類:** **`Squash and merge`** を選択してください。
   * **理由:** 試行錯誤の細かいコミットログを1つにまとめ、`develop` の履歴を「機能単位」で綺麗に保つため。
   * **確認:** マージメッセージにIssue番号が含まれていることを最終確認してください。

---

## 4. リリース運用フロー (Release Flow)

リリースの全体管理は `[リリース担当]` が行いますが、修正作業は `[レビューイ]` が担当します。

### ① リリース準備
* `[リリース担当]` 開発機能が出揃ったら、`develop` から `release/vX.Y` ブランチを作成します。
* **これ以降、このリリースに対する新機能の追加は禁止（コードフリーズ）です。**

### ② 検証・バグ修正（★最重要）
検証フェーズでバグが見つかった場合のフローです。

1. **修正対応:**
   * `[レビューイ]` `release/vX.Y` から `bugfix/xxx` を作成し修正、PRを作成する。
   * `[レビュワー]` 修正内容をレビューし、マージする（**Create a merge commit**）。

2. **バックマージ（Back-merge）:**
   * `[レビューイ]` **修正完了後、即座に `develop` へのバックマージ用PRを作成する。**
     * PRの向き先: `develop` <--- `release/vX.Y`
   * `[リリース担当]` バックマージが漏れていないか定期的に監視する。
   * **理由:** `develop` との乖離を防ぎ、将来のコンフリクト地獄を回避するため。

### ③ 商用リリース
顧客検証完了後の手順です。すべて `[リリース担当]` が実施します。

1. **本番反映:**
   * `[リリース担当]` `release/vX.Y` を `main` へマージする（**Create a merge commit**）。
2. **タグ付け:**
   * `[リリース担当]` `main` ブランチ上でリリースタグ（例: `v1.0.0`）を作成する。
3. **後始末:**
   * `[リリース担当]` 最後に `release/vX.Y` を `develop` にマージし、リリースブランチを削除する。

---

## 5. 禁止事項・注意事項

* **`[全役割]` Cherry-pick の常用禁止:**
  * 依存関係の欠落を防ぐため、緊急Hotfix以外では使用禁止です。
* **`[レビューイ]` Issue番号なしの作業禁止:**
  * すべてのコード変更は何らかのIssueに紐づく必要があります。
* **`[全役割]` Squash Mergeの適用範囲:**
  * `feature` → `develop` 以外（特に `release` 関連のマージ）では使用しないでください。履歴が分断されます。
